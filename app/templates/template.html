<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calculadora de bases</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="card-title text-center mb-3">Calculadora para múltiples bases</h3>

              <form id="calcForm" novalidate>
                <div class="mb-3">
                  <label for="a" class="form-label">Primer número</label>
                  <input id="a" name="a" class="form-control" placeholder="ej. 1010 o A" required inputmode="numeric" />
                  <div id="aHelp" class="form-text">Ingrese dígitos permitidos según la base seleccionada.</div>
                </div>

                <div class="mb-3">
                  <label for="b" class="form-label">Segundo número</label>
                  <input id="b" name="b" class="form-control" placeholder="ej. 111 o 5" required inputmode="numeric" />
                </div>

                <div class="row">
                  <div class="col-6 mb-3">
                    <label for="base" class="form-label">Base</label>
                    <select id="base" name="base" class="form-select">
                      <option value="2">2 (binario)</option>
                      <option value="8">8 (octal)</option>
                      <option value="10" selected>10 (decimal)</option>
                      <option value="16">16 (hexadecimal)</option>
                    </select>
                  </div>
                  <div class="col-6 mb-3">
                    <label for="op" class="form-label">Operación</label>
                    <select id="op" name="op" class="form-select">
                      <option value="add">Suma</option>
                      <option value="subtract">Resta</option>
                      <option value="mul">Multiplicación</option>
                      <option value="div">División</option>
                    </select>
                  </div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-primary">Calcular</button>
                </div>
              </form>

              <div id="result" class="mt-3"></div>
              <div id="error" class="mt-2 text-danger" aria-live="polite"></div>
            </div>
          </div>
          <p class="text-center text-muted small mt-3">La aplicación reenvía a microservicios; si no hay respuesta, realiza el cálculo localmente.</p>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById('calcForm');
      const resultEl = document.getElementById('result');
      const errorEl = document.getElementById('error');
      const aInput = document.getElementById('a');
      const bInput = document.getElementById('b');
      const baseSelect = document.getElementById('base');
      const aHelp = document.getElementById('aHelp');

      // Return a regex that validates allowed characters for given base
      function allowedRegexForBase(base) {
        base = Number(base);
        if (base < 2 || base > 36) base = 10;
        if (base <= 10) {
          const maxDigit = base - 1;
          return new RegExp('^[0-' + maxDigit + ']+$', 'i');
        }
        const lettersCount = base - 10;
        const lastLetter = String.fromCharCode('A'.charCodeAt(0) + lettersCount - 1);
        return new RegExp('^[0-9A-' + lastLetter + ']+$', 'i');
      }

      // Update input attributes to favor numeric keyboard when base is 10
      function updateInputAttributes(base) {
        if (Number(base) === 10) {
          aInput.setAttribute('inputmode', 'numeric');
          bInput.setAttribute('inputmode', 'numeric');
          aInput.setAttribute('pattern', '\\d+');
          bInput.setAttribute('pattern', '\\d+');
        } else {
          aInput.setAttribute('inputmode', 'text');
          bInput.setAttribute('inputmode', 'text');
          aInput.removeAttribute('pattern');
          bInput.removeAttribute('pattern');
        }
      }

      function updateHelpText() {
        const base = Number(baseSelect.value);
        if (base <= 10) {
          aHelp.textContent = `Sólo dígitos 0..${base - 1}`;
        } else {
          const lettersCount = base - 10;
          const lastLetter = String.fromCharCode('A'.charCodeAt(0) + lettersCount - 1);
          aHelp.textContent = `Dígitos 0..9 y letras A..${lastLetter} (no sensibles a mayúsculas)`;
        }
        updateInputAttributes(base);
      }

      baseSelect.addEventListener('change', updateHelpText);
      updateHelpText();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultEl.textContent = '';
        errorEl.textContent = '';

        const a = aInput.value.trim();
        const b = bInput.value.trim();
        const base = Number(baseSelect.value);
        const op = document.getElementById('op').value;

        if (!a || !b) {
          errorEl.textContent = 'Complete ambos números.';
          return;
        }

        // Strict validation: if base 10, ensure only digits 0-9
        const regex = allowedRegexForBase(base);
        if (!regex.test(a)) {
          errorEl.textContent = `Primer número inválido para base ${base}.`;
          return;
        }
        if (!regex.test(b)) {
          errorEl.textContent = `Segundo número inválido para base ${base}.`;
          return;
        }

        resultEl.textContent = 'Calculando...';

        try {
          const resp = await fetch('/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ a: a.toUpperCase(), b: b.toUpperCase(), base, op })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.detail || JSON.stringify(data));
          resultEl.innerHTML = `<div class="alert alert-success" role="status">Resultado: <strong>${data.result ?? JSON.stringify(data)}</strong></div>`;
        } catch (err) {
          resultEl.innerHTML = '';
          errorEl.textContent = 'Error: ' + (err.message || err);
        }
      });
    </script>

    <!-- Bootstrap JS (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
